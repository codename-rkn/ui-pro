<%= simple_form_for( @site_role,
                    url:      @site_role.id ?
                                  site_role_path(@site, @site_role) :
                                  site_roles_path(@site),
                    html: {
                        class:     'site_role-form',
                        onsubmit: 'on_submit()'
                    }
    ) do |f| %>
    <%= f.error_notification %>

    <% if f.error_notification %>
        <div>
            <ul>
                <% @site_role.errors.messages.each do |attribute, messages| %>
                    <li>
                        <%= link_to attribute.to_s.humanize, "#site_role_#{attribute}", class: 'scroll' %>
                        <% if messages.size == 1 %>
                            <%= messages.first %>
                        <% else %>
                            <ul class="list-unstyled">
                                <% messages.each do |message| %>
                                    <li>
                                        <span class="help-block">
                                            <%= message %>
                                        </span>
                                    </li>
                                <% end %>
                            </ul>
                        <% end %>
                    </li>
                <% end %>
            </ul>
        </div>
    <% end %>

    <div class="row">
        <div class="col-md-12">
            <%= f.input :name, label: false, placeholder: 'Name' %>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <%= f.input :description, label: false, placeholder: 'Description',
                        hint: 'You can use Markdown for text formatting.',
                        input_html: { rows: 5, cols: 100 } %>
        </div>
    </div>

    <%= f.input :login_type, label: false, wrapper_html: { class: 'hide' } %>

    <div id="session">
        <fieldset>
            <h2 id="session-h">
                Session
                <small>How will scanner determine its session's validity?</small>
            </h2>

            <div class="row">
                <div class="col-md-7">
                    <%= f.input :session_check_url, as: :string, label: false,
                                placeholder: "Check URL (Example: #{@site.url})" %>
                    <%= messages_for( :session_check_url ) %>

                    <%= f.input :session_check_pattern, as: :string, label: false,
                                placeholder: 'Check pattern (Example: profile/admin)' %>
                    <%= messages_for( :session_check_pattern ) %>

                    <%= f.input :scope_exclude_path_patterns, label: false,
                                placeholder: 'Log-out exclusion patterns (Example: logout)',
                                as: :text,
                                input_html: { value: @site_role.scope_exclude_path_patterns.join( "\n" ) }%>

                    <%= messages_for( :scope_exclude_path_patterns ) %>
                    <p class="help-block">Input each rule in its own line.</p>
                </div>

                <div class="col-md-5">
                    <div class="card bg-light">
                        <div class="card-header">
                            Let's say there's a page at <code><%= @site.url %></code>:
                        </div>
                        <div class="card-body">
                            <%= code_highlight do %>
<!-- [...] -->

<div class="menu">
    Hello <a href="/profile/admin">Admin</a>! | <a href="/logout">Log out</a>
</div>

<!-- [...] -->
                            <% end %>

                            <em>
                                Assuming this content only appears when the
                                <kbd>admin</kbd> user is logged in.
                            </em>
                            <hr/>

                            <p class="alert alert-info">
                                The options on the left are filled in with example
                                values for this case.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>
    </div>

    <hr/>

    <div id="login">
        <fieldset>
            <h2 id="login-h">
                Log-in procedure
                <small>How will the scanner log-in?</small>
            </h2>

            <div class="row">
                <div class="col-md-7">
                    <div role="tabpanel" class="type-tabs">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <a class="nav-link <%= 'active' if !@site_role.login_type || @site_role.login_type == 'form' %>" href="#!/form" role="tab">Form</a>
                            </li>

                            <li class="nav-item" role="presentation">
                                <a class="nav-link <%= 'active' if @site_role.login_type == 'script' %>" href="#!/script"  role="tab" >Script</a>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <div class="tab-pane <%= 'active' if !@site_role.login_type || @site_role.login_type == 'form' %>"
                                 role="tabpanel"
                                 id="form">

                                <div class="help-block">
                                    When using form-based authentication the system
                                    will look for a form whose inputs include the
                                    specified parameters at the given URL.
                                </div>

                                <div class="alert alert-warning">
                                    This method operates a browser just like a
                                    regular user would and is thus limited to the
                                    same extent.
                                    <br/>
                                    For example, if the login form is hidden and
                                    requires a sequence of interface interactions
                                    in order to become visible, it will not be
                                    possible to submit it.
                                    <br/>
                                    In cases where a sequence of events needs to
                                    be triggered, the <a href="#!/script">script</a> method
                                    should be preferred instead.
                                </div>

                                <%= f.input :login_form_url, as: :string, label: false,
                                            placeholder: "URL (Example: #{@site.url}/login)" %>

                                <%= f.input :login_form_parameters, label: false,
                                            placeholder: 'Parameters (Example: user=admin and passwd=secret)',
                                            as: :text,
                                            input_html: {
                                                    value: @site_role.login_form_parameters.map { |k, v| "#{k}=#{v}" }.join( "\n" )
                                            }
                                %>

                                <p class="help-block">
                                    Parameters take the format of <kbd>name=value</kbd>,
                                    input each pair in its own line.
                                </p>
                            </div>

                            <div class="tab-pane <%= 'active' if @site_role.login_type == 'script' %>"
                                 role="tabpanel"
                                 id="script">
                                <p class="alert">
                                    Script-based logins allow you to run arbitrary
                                    <a target="_blank" href="https://www.ruby-lang.org/">Ruby</a>
                                    code in order to perform the log-in operation.
                                </p>

                                <div class="row">
                                    <div class="col-md-3">
                                        <ul class="nav nav-stacked nav-horizontal">
                                            <li>
                                                <a href="#" data-toggle="modal"
                                                   data-target="#login-script-browser">
                                                    Browser driver
                                                </a>
                                                <p class="text-muted">
                                                    When interaction with the user interface or
                                                    execution of Javascript is required.
                                                </p>
                                            </li>
                                            <li>
                                                <a href="#" data-toggle="modal"
                                                   data-target="#login-script-http">
                                                    HTTP client
                                                </a>
                                                <p class="text-muted">
                                                    When the operation can be performed with
                                                    HTTP requests alone.
                                                </p>
                                            </li>
                                        </ul>

                                        <%= render partial: 'site_roles/login/browser_modal' %>
                                        <%= render partial: 'site_roles/login/http_modal' %>
                                    </div>

                                    <div class="col-md-9">
                                        <div id="site_role_login_script_code_editor"><%= @site_role.login_script_code %></div>
                                        <samp><%= f.input :login_script_code %></samp>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card bg-light">
                        <div class="card-header">
                            Let's say there's a form at <code><%= @site.url %>/login</code>:
                        </div>
                        <div class="card-body">
                            <%= code_highlight do %>
<!-- [...] -->

<form id="login-form" method="post" action="/do_login">
    <label for="user">Username</label>
    <input name="user" id="user" type="text"/>

    <label for="passwd">Password</label>
    <input name="passwd" id="passwd" type="password"/>

    <input type="submit" value="Login"/>
</form>

<!-- [...] -->
                            <% end %>

                            <hr/>

                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th>Username</th>
                                    <td><kbd>admin</kbd></td>
                                </tr>

                                <tr>
                                    <th>Password</th>
                                    <td><kbd>secret</kbd></td>
                                </tr>
                            </table>

                            <hr/>

                            <p class="alert alert-info">
                                The procedure options on the left are filled in
                                with example values for this form.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>
    </div>
<% end %>

<% if @site_role.login_script_code_error_line %>
<style>
    div.ace_gutter-cell:nth-of-type(<%= @site_role.login_script_code_error_line %>),
    div.ace_line_group:nth-of-type(<%= @site_role.login_script_code_error_line %>) {
        background-color: rgba( 255, 0, 0, 0.3 );
    }
</style>
<% end %>

<script>
    ace_editor( 'site_role_login_script_code_editor' );

    function on_submit() {
        $('#site_role_login_type').val( $('div.type-tabs div.tab-pane.active').attr('id') );

        var editor_value =
                ace_editor('site_role_login_script_code_editor').
                        getSession().
                        getValue();

        $('#site_role_login_script_code').val( editor_value );
    }
</script>
